# 用户用水行为识别系统 - 本地存储版使用说明

本文档说明如何使用本地存储版本的用户用水行为识别系统，该版本移除了PostgreSQL数据库依赖，所有数据都存储在本地文件系统中，系统运行速度更快，部署更加简便。

## 一、系统特点

1. **无数据库依赖**：移除PostgreSQL数据库依赖，使用本地文件存储所有数据
2. **半年自动清理**：系统会自动保留最近半年的数据，过期数据会被清理
3. **性能更高**：文件读写速度快于远程数据库连接
4. **部署简单**：无需配置数据库连接信息
5. **数据备份**：在清理前会自动备份数据，并提供警告

## 二、目录结构

```
用户用水行为系统/
├─ api_server_local.py   # API服务器（本地存储版）
├─ run_local.py          # 启动脚本（本地存储版）
├─ local_storage.py      # 本地存储管理模块
├─ app.py                # Streamlit前端
├─ data/                 # 数据存储目录
│  ├─ devices.json       # 设备信息
│  ├─ users.json         # 用户信息
│  └─ backup_*.csv       # 数据备份文件
├─ water_meter_data.csv  # 水表数据主文件
└─ device_push_data.csv  # 设备推送数据记录
```

## 三、快速开始

### 1. 系统要求

- Python 3.7+
- 必要的Python库：fastapi, uvicorn, pandas, streamlit等
- 可使用requirements.txt安装依赖：`pip install -r requirements.txt`

### 2. 启动系统

使用run_local.py脚本启动整个系统：

```bash
python run_local.py
```

此命令将同时启动API服务器和Streamlit前端。

#### 启动选项

- 仅启动API服务器：`python run_local.py --api-only`
- 仅启动Streamlit前端：`python run_local.py --streamlit-only`
- 指定API端口：`python run_local.py --api-port 8888`
- 指定Streamlit端口：`python run_local.py --streamlit-port 9000`

### 3. 访问系统

- **Web界面**：http://localhost:8501
- **API服务**：http://localhost:8000

## 四、数据清理机制

本系统实现了自动数据清理机制，以确保系统长期运行时不会因为数据过多而变慢：

1. **清理策略**：系统默认保留最近180天（约半年）的数据
2. **警告机制**：清理前7天开始在系统中显示警告信息
3. **自动备份**：执行清理前会自动备份数据到data/backup_*.csv文件
4. **手动导出**：用户可以在数据管理页面手动导出数据

## 五、设备管理

本地存储版系统支持完整的设备管理功能：

1. **设备列表**：查看、搜索和筛选所有设备
2. **设备详情**：查看设备信息和统计数据
3. **添加/编辑设备**：添加新设备或编辑现有设备
4. **批量导入**：通过CSV/Excel文件批量导入设备信息

## 六、数据推送

设备数据推送API与原版系统完全兼容：

- **API端点**：http://[服务器IP]:8000/api/data
- **请求方法**：POST
- **数据格式**：JSON，详见`水表数据推送接口文档.md`

## 七、文件说明

- **local_storage.py**：提供本地文件存储的核心功能，包括设备管理、数据存储与查询、用户认证和数据自动清理功能
- **api_server_local.py**：基于FastAPI的API服务器，使用local_storage模块进行本地数据存储
- **run_local.py**：启动脚本，用于同时启动API服务器和Streamlit前端

## 八、用户账户

系统默认创建管理员账户：

- **用户名**：admin
- **密码**：admin123

请在首次登录后修改默认密码。

## 九、常见问题

### Q: 如何更改数据保留时间？

A: 打开local_storage.py文件，修改`DATA_RETAIN_DAYS`变量的值（默认为180天）。

### Q: 数据会自动删除吗？

A: 是的，超过设定保留期限（默认半年）的数据会自动清理，但会在清理前进行备份。

### Q: 如何备份所有数据？

A: 在数据管理页面使用"导出数据"功能，或直接复制`water_meter_data.csv`、`data`文件夹和`device_push_data.csv`文件。

### Q: 如何导入历史数据？

A: 可以使用data_simulator.py或push_history_data.py脚本推送历史数据，或直接将备份的CSV文件复制到系统目录。

## 十、备注

本地存储版本是完全独立的系统，与原数据库版本不共享数据。如需迁移原数据库数据到本地存储版本，请使用migrate_to_local.py脚本进行迁移。 