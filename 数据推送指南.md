# 用户用水行为识别系统 - 数据推送指南

本文档介绍如何使用数据推送工具向系统中推送历史数据和实时数据。

## 1. 系统说明

用户用水行为识别系统包含以下组件：
- API服务器：接收数据、处理请求，默认在8000端口
- Streamlit前端：用户界面，默认在8501端口
- PostgreSQL数据库：存储设备和水表数据

## 2. 数据推送工具

我们提供了三个数据推送工具：

### 2.1 推送历史数据 (push_history_data.py)

这个工具用于一次性推送过去30天的历史数据，可以快速填充系统数据库。

**使用方法：**
```bash
python push_history_data.py
```

工具会读取 `1757125983314设备历史数据数据.csv` 文件，并生成模拟过去30天的数据。每天的数据会基于原始数据模板，但日期会调整为模拟的日期，流量值也会适当调整。

### 2.2 推送实时数据 (push_realtime_data.py)

这个工具模拟水表设备定时上报数据的行为，可以按照指定的间隔持续推送数据。

**使用方法：**
```bash
python push_realtime_data.py
```

工具会让你输入：
- 推送间隔（秒）：多长时间发送一次数据
- 运行时长（分钟）：工具运行多长时间，留空则持续运行

工具会模拟不同的用水行为模式（静默期、小量用水、正常用水、大量用水），并根据这些行为生成合理的数据。

### 2.3 综合模拟器 (data_simulator.py)

这是一个更复杂的模拟工具，提供菜单式界面和更多选项。

**使用方法：**
```bash
python data_simulator.py
```

工具提供三个主要功能：
1. 推送历史数据（过去一个月）
2. 模拟实时数据推送
3. 同时执行上述两项功能

## 3. 数据格式说明

水表数据接口要求以下字段：

| 字段名 | 说明 | 示例 |
|-------|------|------|
| deviceNo | 表号 | 70666000038000 |
| imei | IMEI号 | 860329065551923 |
| totalFlow | 累计流量(m³) | 117.4214 |
| instantaneousFlow | 瞬时流量(m³/h) | 0.0133 |
| freezeDateFlow | 冻结流量 | 117.42 |
| reverseFlow | 反向流量 | 0.51 |
| startFrequency | 启动次数 | 21180 |
| temprature | 温度(°C) | 22.48 |
| pressure | 压力 | 0.0 |
| batteryVoltage | 电池电压(V) | 3.626 |
| signalValue | 信号值(dBm) | -85 |
| valveStatu | 阀门状态 | 开 |
| updateTime | 上报时间 | 2025-09-05 23:32:59 |

## 4. 故障排除

### 连接问题

如果遇到连接问题，请检查：
1. API服务器是否正在运行 (`python run.py --api-only`)
2. API地址和端口是否正确（默认为 http://localhost:8000）
3. 设备是否已在系统中注册

### 数据问题

如果数据显示异常，请检查：
1. 推送的数据格式是否正确
2. 时间戳是否合法
3. 流量值是否合理（应该随时间递增）

## 5. 开发自定义推送工具

如果需要开发自定义的数据推送工具，可以参考现有工具的代码。核心API调用如下：

```python
import requests

API_ENDPOINT = "http://localhost:8000/api/data"

data_point = {
    "batteryVoltage": "3.626",
    "deviceNo": "70666000038000",
    "freezeDateFlow": "117.42",
    "imei": "860329065551923",
    "instantaneousFlow": "0.0133",
    "pressure": "0.0",
    "reverseFlow": "0.51",
    "signalValue": "-85",
    "startFrequency": "21180",
    "temprature": "22.48",
    "totalFlow": "117.4214",
    "valveStatu": "开",
    "updateTime": "2025-09-05 23:32:59"
}

response = requests.post(API_ENDPOINT, json=data_point)
print(response.status_code, response.text)
``` 