# 用户用水行为识别系统说明文档

## 项目概述

用户用水行为识别系统是一个基于水表数据采集、分析和可视化的综合平台。系统通过接收水表设备上报的数据，对用户用水行为进行分析和分类，识别出不同的用水场景，并提供异常用水检测功能，帮助用户了解用水模式，发现潜在的漏水问题。

### 系统特点

- **多源数据接入**：支持多种格式的数据源，包括CSV、Excel以及实时设备推送
- **实时监测**：展示水表的实时数据，包括累计流量、瞬时流量、温度和电池电压
- **历史查询**：按日期查询历史用水数据，展示用水趋势和行为分类
- **异常检测**：识别大流量用水、夜间用水和疑似漏水等异常情况
- **数据管理**：支持数据导出和删除操作
- **设备管理**：管理水表设备信息，包括添加、更新设备
- **多级权限**：管理员登录功能，保护关键操作
- **数据库支持**：使用Neon PostgreSQL数据库存储数据，确保数据安全和高效查询

## 系统架构

### 后端架构

后端基于FastAPI构建，提供高性能的API服务，主要包括：

1. **数据接收模块**：接收水表设备推送的数据
2. **数据存储模块**：将数据存储到CSV文件和PostgreSQL数据库
3. **设备管理模块**：管理水表设备信息
4. **用户认证模块**：提供管理员登录和认证功能
5. **数据查询模块**：提供历史数据查询接口

### 前端架构

前端使用Streamlit构建，提供直观的用户界面，主要包括：

1. **登录页面**：管理员登录入口
2. **实时监测页面**：展示水表实时数据
3. **历史查询页面**：查询和展示历史用水数据
4. **上传分析页面**：上传CSV/Excel文件进行分析
5. **数据管理页面**：管理数据导出和删除
6. **设备管理页面**：管理水表设备信息

### 数据流程

```
设备数据推送 --> FastAPI接收 --> 数据标准化 --> 存储(CSV/数据库)
                                     |
                                     v
                              用水行为分析 --> 异常检测
                                     |
                                     v
                              Streamlit可视化
```

## 功能模块详解

### 1. 数据接收与标准化

系统支持通过API接收水表设备推送的数据，数据格式需符合《水表数据推送接口文档》中的规范。接收到的数据会进行标准化处理，统一字段名称和数据类型，确保后续分析的准确性。

主要字段及单位：
- **deviceNo/imei**: 设备编号/IMEI号
- **instantaneousFlow**: 瞬时流量(m³/h)
- **totalFlow**: 累计流量(m³)
- **temprature**: 温度(°C)
- **batteryVoltage**: 电池电压(V)
- **signalValue**: 信号强度(dBm)
- **updateTime**: 更新时间(YYYY-MM-DD HH:MM:SS或毫秒时间戳)

### 2. 用水行为分析

系统基于瞬时流量和用水时长对用水行为进行分类：



分析算法通过对流量数据进行分段和特征提取，识别关键点并进行分类。

### 3. 异常检测

系统提供多种异常检测功能：

- **大流量用水检测**：识别超过阈值的大流量用水事件
- **夜间用水检测**：识别夜间时段(23:00-6:00)的用水行为
- **漏水检测**：识别长时间持续的小流量用水，可能表示漏水

### 4. 可视化展示

系统提供多种可视化图表：

- **流量趋势图**：展示瞬时流量和累计流量的变化趋势
- **用水行为饼图**：展示不同用水行为的占比
- **增强图**：三联图展示流量、温度和电池/信号强度的变化，并标记关键用水点

### 5. 设备管理

系统提供水表设备的管理功能：

- **添加设备**：添加新的水表设备信息
- **更新设备**：更新现有设备的信息
- **查看设备列表**：查看所有已注册的设备

### 6. 数据管理

系统提供数据管理功能：

- **数据导出**：导出指定时间范围的数据
- **数据删除**：删除指定时间范围的数据

## 部署说明

### 环境要求

- Python 3.8+
- PostgreSQL数据库(Neon云数据库)
- 网络环境：支持内网或公网部署

### 依赖安装

```bash
pip install -r requirements.txt
```

主要依赖包括：
- fastapi
- uvicorn
- streamlit
- pandas
- plotly
- matplotlib
- psycopg2-binary
- pydantic
- python-jose[cryptography]
- python-multipart

### 配置说明

系统支持以下环境变量配置：

- **NEON_URL**：Neon数据库连接字符串
- **ADMIN_USERNAME**：管理员用户名(默认admin)
- **ADMIN_PASSWORD**：管理员密码(默认admin123)
- **JWT_SECRET**：JWT密钥(默认自动生成)
- **JWT_EXPIRE_MINUTES**：JWT过期时间(默认60分钟)
- **RATE_LIMIT_PER_MINUTE**：API请求速率限制(默认240次/分钟)
- **CORS_ORIGINS**：CORS允许的源(默认*)
- **ENABLE_UPNP**：是否启用UPnP端口映射(默认0)
- **EXTERNAL_PORT**：外部端口号(默认8000)

### 启动服务


```

### 外部访问配置

系统支持多种外部访问方式：

1. **局域网访问**：
   - 后端API：http://{局域网IP}:8000
   - 前端界面：http://{局域网IP}:8501

2. **公网访问**：
   - 配置路由器端口转发(8000和8501端口)
   - 如遇CGNAT问题，可使用Cloudflare Tunnel等工具

## 使用指南

### 管理员登录

1. 访问前端界面：http://{IP}:8501
2. 输入管理员用户名和密码登录

### 实时监测

实时监测页面展示最新的水表数据，包括：
- 累计流量
- 瞬时流量
- 温度
- 电池电压
- 信号强度

数据每30秒自动刷新一次。

### 历史查询

1. 选择查询日期
2. 系统将展示该日期的用水数据，包括：
   - 流量趋势图
   - 用水行为分类
   - 异常用水统计
   - 用户用水行为识别图  跟enhanced_plot_cn.py 逻辑保持一样

### 上传分析

1. 上传CSV或Excel格式的水表数据文件
2. 系统将自动标准化数据并进行分析
3. 展示分析结果，包括流量趋势图和增强图

### 数据管理

1. 选择时间范围
2. 可以导出或删除指定时间范围的数据

### 设备管理

1. 查看已注册的设备列表
2. 添加新设备：输入设备编号、IMEI号等信息
3. 更新设备信息：修改现有设备的信息

## 数据推送指南

外部设备可以通过HTTP POST请求向系统推送数据：

```python
import requests
from datetime import datetime

URL = "http://{IP}:8000/api/data"
payload = {
    "batteryVoltage": "3.626",
    "deviceNo": "70666000038000",
    "freezeDateFlow": "117.42",
    "imei": "860329065551923",
    "instantaneousFlow": "0.0033",  # 单位：m³/h
    "pressure": "0.00",
    "reverseFlow": "0.00",
    "signalValue": "-85",           # 单位：dBm
    "startFrequency": "21160",
    "temprature": "22.48",          # 单位：°C
    "totalFlow": "117.4214",        # 单位：m³
    "valveStatu": "开",
    # 时间格式：YYYY-MM-DD HH:MM:SS
    "updateTime": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    # 也可用毫秒时间戳：int(datetime.now().timestamp() * 1000)
}

resp = requests.post(URL, json=payload, timeout=5)
print(resp.status_code, resp.text)
```

## 数据库结构

系统使用Neon PostgreSQL数据库，主要表结构如下：

